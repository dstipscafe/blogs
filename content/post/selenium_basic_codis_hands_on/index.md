---
title: "[互動式爬蟲系列2] Selenium 基礎"
description: 讓瀏覽器自己動起來，好像很有趣？
slug: selenium_basic_codis_hands_on
date: 2024-07-20 22:00:00+0800
image: cover.jpg
categories:
    - side_projects
    - blogs
    - python
tags:
    - blogs
    - Data pipeline
    - Web Scaping
---

## 前言

在上一篇[文章](https://dstipscafe.github.io/blogs/p/selenium_basic/)中，我們介紹了Selenium的基礎概念以及操作示範。在這篇文章中，我們將以台灣中央氣象署為目標，實際使用Selenium來爬取特定測站的當日氣象觀測數據。

## 中央氣象署氣候觀測資料查詢服務

[氣候觀測資料查詢服務（CODiS）](https://codis.cwa.gov.tw/StationData)是台灣中央氣象署所提供的便民查詢服務。民眾可以藉由此服務查詢特定測站在特定日期的天候觀測資料。資料包含雨量、氣溫、濕度風速等等觀測資料。在時間尺度上，提供所有項目的每日、每月、每年以及單項資料的逐日、逐月、逐年資料。

在舊版網站中，我們可以直接透過使用**測站代號**、**測站海拔**以及其他必要資訊，以**GET**請求加上參數的形式直接獲取資料。但在新版的網站中，整個網站架構進行了相當大的改版，且引入了**session**的機制讓以往的資料爬取方式無法在使用。雖然仍可以使用戳API的方式獲取資料，但必須改用**POST**，且需要一些額外的步驟才能取得資料，同時，資料也不像網頁所提供的，是已經整理過的版本，而是以JSON形式交付的原始資料（Raw Data）。由於資料形式不同，在整理上需要花費額外的時間。

倘若想要獲取如同以往形式的資料，則需要透過Selenium來進行互動式爬蟲才能達成。我們將一步一步示範如何使用Selenium來達成這項工作。

## 流程建立

### 前置觀察

#### 基本測站標記觀察

使用Selenium進行爬蟲，基本上就是把人為的操作以電腦的手段進行實現，為此，我們需要先了解目標網站在查詢目標資料時，需要哪些步驟。首先，我們可以先看一眼未經任何操作的網站狀態：

![未經任何操作的網站狀態](image.png)

可以發現到畫面主要分成左右兩側，左邊是篩選面板，右邊是地圖形式的顯示面板，讓使用者可以透過點擊地圖上的標記來展開測站資料。預設可以直接點擊的測站（紅色標記）僅有四個，其他的測站以區域為分類，使用了帶有數字的標記來簡化顯示的標記數量。在點擊北部的標記後，可以發現網站進行了縮放，並顯示出被分類在北部的測站標記。

![北部測站標記](image-1.png)

我們也會注意到，在左側具有兩個與區域有關的篩選功能，分別為「區域」、「山地」以及「縣市」。以縣市作為範例，先篩選縣市可以讓地圖中指定縣市的標記出現。

![新北市測站標記](image-3.png)

觀察小結：當需要篩選特定區域測站時，可以使用左側篩選欄位的「區域」、「山地」或是「縣市」進行篩選，也可以透過點擊地圖上的分類標記來進行篩選。

#### 測站名稱代號篩選觀察

我們也可以在左方篩選欄位注意到，有一個「站名站號」的篩選功能，以台北測站（測站代號：466920）為例，直接輸入此測站代號可以直接讓地圖上指定的標記出現。

![台北測站（點擊標記後）](image-4.png)

#### 測站分類觀察

在預設中，網站僅顯示了**署屬有人站**的標記，當需要選取其他標記的時候，則需要將指定類別打勾，方能出現對應的標記。

![測站分類觀察](image-2.png)

#### 測站標記行為觀察（以台北測站為例）

我們接下來進行標記的行為觀察。以台北測站為例，在點擊標記後會出現對應的資訊匡：

![台北測站（點擊標記後）](image-4.png)

點擊「觀看時序圖報表」後，可以展開細部資訊欄位：

![台北測站細部資訊](image-5.png)

在細部資訊頁面中，我們可以透過點擊日期來觸發日期選擇的功能：

![日期選單](image-6.png)

也可以透過點擊年份以及月份來觸發年份以及月份選單：

![年份選單](image-7.png)

![月份選單](image-8.png)

並在點擊指定日期後，查詢特定日期的測資：

![指定日期測資](image-9.png)

並可以透過點擊「CSV下載」按鈕來進行資料下載：

![下載畫面](image-10.png)

到這個階段，我們已經大致可以規劃出整體的程式碼需要如何實踐了。

#### 日期選單觀察

當有需要選取特定日期時，日期選單的細節就變得非常重要。接下來我們將觀察並建立操作日期選單的基礎。首先，我們一樣可以透過**inspect**來觀察日期選單在網頁中的組成。

![日期選單的物件組成](image-12.png)

可以注意到日期選單本身是一個帶有**class**為**vdatetime**的物件，這代表我們可以透過選擇策略搭配**CLASS＿NAME**來找到日期選單。

![日期選單內部物件1](image-13.png)

接下來，我們可以藉由展開**vdatetime**物件，來觀察內部的組成。在選擇年份及月份的部分，為一個帶有**class**為**vdatetime-popup__year**的**div物件**，同時，選擇月份的部分則是**class**為**vdatetime-popup__month**的**div物件**。

![日期選單內部物件2](image-14.png)

在日期部分，則是與年份以及月份的命名規則不同，為一個帶有**class**為**vdatetime-popup__body**的**div物件**。

##### 年份選擇

在進一步點擊年份之後，可以發現表單變成了選擇年份的模式，接下來我們可以觀察網站物件的變化。

![年份選單](image-15.png)

可以發現**vdatetime-popup__body**的**div物件**從日期變成了年份的選單，且網站的程式碼自動生成了一組**class**雷同的年份物件，並透過細部的差異（即`disable`部分）來控制可以選擇的年份。

##### 月份選擇

接下來，我們同樣點擊月份選單的部分，可以發現其運作模式與年份選單相同。

![月份選單](image-16.png)

##### 日期選擇

最後，我們回到最初始的狀態來行日期的選擇。

![日期選單](image-18.png)

可以注意到**body**中有一個**calendar**物件，在其中分別有**navigation**、**month**以及**day**。前者可以切換月份，中間是顯示週一至週日的標籤，後者則是我們所需要的日期選擇部分。可以注意到整體模式與年份以及月份的選單是相同的邏輯。

###### 日期選單觀察小結

網頁中的日期選單是採用了Javascript進行動產生的，其規則簡單，可是因為其**class**沒有根據物件進行客製化，在選擇上需要一些技巧。


## 在開始之前

在開始之前，想介紹以及說明一些在進行互動式爬蟲時需要注意的部分。

### 注意進行操作後可能需要一段時間才會出現對應的物件

在現代的網站設計中，在點擊後以Javascript產生對應物件的行為是非常普遍的，而這個「產生」的動作是會需要花費時間的。在此之上，如何合理的運用上一篇文章中所提及的「等待策略」就是非常重要的。

### 注意自動產生的物件

在上一點中，我們提及了自動產生物件的狀況是非常常見的。在此之後，每一個物件的對應標籤（例如：CSS Selector或是tag等等）可能就不具有一定的順序性或是命名的可循性，甚至可能多個物件帶有相同的名稱（如同日期選單的觀察，在本網站中，日期選單的大部分物件都有類似狀況。）這時候如何靈活的運用上一篇文章中的「選擇策略」就顯得非常重要。

### 選擇策略的靈活性

在上一篇文章中，我們示範了使用了`driver.find_element()`來找到特定物件的作法。其實在這個做法之上，也可以使用`driver.find_element()`所回傳的物件（假設為`object`）本身帶有的`object.find_element()`方法，來限縮搜尋的範圍。在後面的範例中我們相會大量使用到這個技巧。

### 善用XPATH的功能

在XPATH的使用上，不單只是直接的指出某一個物件的位置而已。雖然透過**複製完整的XPATH**也可以達成效果，但這種方法在網頁有所改動時，容易出現錯誤。這時候，我們可以使用XPATH所提供的配對功能來進行模糊搜尋，以提升整體程式碼的易讀性以及維護性。以下是一個簡單的例子：

```
"//div[@class='row' and .//*[contains(text(), '縣市')]]"
```

以上這個表達式，可以找出符合以下條件的`<div>`物件：

1. `class`為**row**
2. 其內部元素的物件帶有文字，且文字內容包含**縣市**

![縣市的XPATH](image-11.png)

這個技巧會在後續的範例中出現。

{{< notice tips >}}

關於這部分的詳細介紹，可以參考以下兩個網站：
1. [Everything You Need to Know About the XPath Contains() Function](https://www.roborabbit.com/blog/everything-you-need-to-know-about-the-xpath-contains-function/)
2. [XPath Syntax by W3School](https://www.w3schools.com/xml/xpath_syntax.asp)

{{< /notice >}}

## 流程規劃

### 找到指定測站

根據先前的前置準備，我們可以建構以下流程(給定一個測站代號)：

1. 檢查是否為「署屬有人站」
   1. 是，不需額外動作
   2. 否，需要進行對應測站類別勾選
2. 找到「站名站號」的物件，並輸入給定的測站代號
3. 等待網站運作直到測站標記出現
4. 點擊測站標記並等待網站運作
5. 點擊「觀看時序圖報表」按鈕，並等待網站運作
6. 確認是否有指定日期
   1. 若否，則直接下載當日資料
   2. 若有，則進行日期選定
      1. 選擇年份，並等待網站運作
      2. 選擇月份，並等待網站運作
      3. 選擇日期，並等待網站運作
      4. 點擊下載
7. 完成

以上就是初步的流程規劃。接下來我們將進行實作示範。